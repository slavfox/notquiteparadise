---
name: NQP - Checks

on:
  pull_request:
    types: [opened, edited, synchronize]
  push:
    branches:
      - '!develop'
      - '!master'
      - pypy


jobs:
  build:
    name: Checks
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: [3.8, pypy37]
      fail-fast: false

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v2

      - uses: actions/setup-python@v2
        if: ${{ matrix.python-version == '3.8' }}
        with:
          python-version: ${{ matrix.python-version }}

      - name: Set pip cache dir on 3.8
        if: ${{ matrix.python-version == '3.8' }}
        run: |
          python -m pip install --upgrade pip
          python -m pip cache dir > vendor/pip_cache_dir.txt
          echo $(which python) > vendor/pycmd

      - name: Get pypy37 on Windows
        if: ${{ matrix.python-version == 'pypy37' && matrix.os == 'windows-latest' }}
        run: |
          cd vendor/
          curl -L -O https://downloads.python.org/pypy/pypy3.7-v7.3.2-win32.zip
          unzip pypy3.7-v7.3.2-win32.zip
          cd pypy3.7-v7.3.2-win32/
          echo $(pwd) >> $GITHUB_PATH
          ln -s $(pwd)/pypy3.exe $(pwd)/python
          ./pypy3.exe -m ensurepip
          ./pypy3.exe -m pip cache dir > ../pip_cache_dir.txt
          echo $(pwd)/pypy3.exe > ../pycmd

      - name: Get pypy37 on Ubuntu
        if: ${{ matrix.python-version == 'pypy37' && matrix.os == 'ubuntu-latest' }}
        run: |
          cd vendor/
          curl -L -O https://downloads.python.org/pypy/pypy3.7-v7.3.2-linux64.tar.bz2
          tar -xf pypy3.7-v7.3.2-linux64.tar.bz2
          cd pypy3.7-v7.3.2-linux64/bin/
          echo $(pwd) >> $GITHUB_PATH
          ./pypy3 -m ensurepip
          ./pypy3 -m pip cache dir > ../pip_cache_dir.txt
          echo $(pwd)/pypy3 > ../pycmd

      - name: Locate Pip Cache
        id: pip-cache
        run: echo "::set-output name=dir::$(cat vendor/pip_cache_dir.txt)"

      - name: Cache dependencies
        uses: actions/cache@v2
        with:
          path: ${{ steps.pip-cache.outputs.dir }}
          key: ${{ runner.os }}-pip-${{ hashFiles('**/poetry.lock') }}
          restore-keys: ${{ runner.os }}-pip-

      - name: Install Linux dependencies
        if: ${{ matrix.os == 'ubuntu-latest' }}
        run: |
          sudo apt-get update
          sudo apt-get install libsdl2-dev
          sudo apt-get install python-sphinx

      - name: Install dependencies
        run: |
          $(cat vendor/pycmd) -V
          $(cat vendor/pycmd) -m pip install --upgrade poetry
          $(cat vendor/pycmd) -m poetry config virtualenvs.create false
          $(cat vendor/pycmd) -m poetry install --no-root -E docs

      - name: Check code formatting
        run: |
          $(cat vendor/pycmd) -m poetry run black --check scripts/

      - name: mypy Type Check
        if: ${{ matrix.python-version == '3.8' }}
        run: |
          $(cat vendor/pycmd) -m poetry run mypy scripts/

      - name: Pytest with Coverage
        run: |
          $(cat vendor/pycmd) -m poetry run pytest --cov=nqp

      - name: Check Docs Build
        run: |
          sphinx-apidoc -o ./docs .
          cd docs
          sphinx-build -a -E --keep-going . _build
